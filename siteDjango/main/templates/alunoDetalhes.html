{% extends "index.html" %}
{% block inicio %}
    <a href="{% url 'adminDashboard' %}"><i class="fas fa-home"></i> Início</a>
    <a href="{% url 'perfil' %}"><i class="fas fa-user"></i> Perfil</a>
{% endblock inicio %}
{% block content %}
    <body>
        <div class="container mt-4">
            <div class="alunoDetalhes">
                <h1>Aluno - {{ aluno.nome }}</h1>
                <p>Idade: {{ aluno.idade }} anos</p>
                <p>Responsável: {{ aluno.responsavel }}</p>
            </div>
            <h2>Mensalidades</h2>
            <table class="table table-striped2">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th>Valor</th>
                        <th>Data de Vencimento</th>
                        <th>Status</th>
                        <th>Data do Pagamento</th>
                        <th>Forma de Pagamento</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mensalidade in mensalidades %}
                    <tr class="{% if mensalidade.status == 'Pago' %}status-pago{% elif mensalidade.status == 'Em Atraso' %}status-atrasado{% else %}status-pendente{% endif %}">
                        <td>{{ mensalidade.mes_nome }}</td>
                        <td>R$ {{ mensalidade.valor }}</td>
                        <td>{{ mensalidade.data_vencimento }}</td>
                        <td>{{ mensalidade.status }}</td>
                        <td>
                            {% if mensalidade.dia_pagamento_realizado %}
                                {{ mensalidade.dia_pagamento_realizado }}
                            {% else %}
                                ---
                            {% endif %}
                        </td>
                        <td>
                            {% if mensalidade.status == "Pago" %}
                                {{ mensalidade.forma_pagamento }}
                            {% else %}
                                <select name="forma_pagamento" class="form-select pagamento-select">
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Cartão">Cartão</option>
                                    <option value="PIX">PIX</option>
                                </select>
                            {% endif %}
                        </td>
                        <td>
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="mensalidade_id" value="{{ mensalidade.id }}">
        
                                {% if mensalidade.status == "Pago" %}
                                    <button type="submit" name="acao" value="desmarcar_pago" class="btn btn-warning" onclick="return confirm('Tem certeza?')">
                                        Desmarcar Pagamento
                                    </button>
                                {% else %}
                                    <button type="submit" name="acao" value="marcar_pago" class="btn btn-success" onclick="return validarPagamento(this)">
                                        Marcar como Pago
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <script>
            function validarPagamento(botao) {
                // Obtém o select na mesma linha do botão clicado
                let linha = botao.closest("tr");
                let select = linha.querySelector(".pagamento-select");
        
                // Verifica se o usuário selecionou uma forma de pagamento
                if (!select || select.value === "") {
                    alert("Por favor, selecione a forma de pagamento antes de confirmar.");
                    return false; // Impede o envio do formulário
                }
        
                // Adiciona um campo oculto ao formulário para enviar a escolha
                let inputOculto = document.createElement("input");
                inputOculto.type = "hidden";
                inputOculto.name = "forma_pagamento";
                inputOculto.value = select.value;
                botao.closest("form").appendChild(inputOculto);
        
                return confirm("Confirme o pagamento.");
            }
        </script>

                    <div style="display: flex; justify-content: center; gap: 10px;">
                <a href="{% url 'turmaDetalhes' aluno.turma.id %}" style="text-decoration: none;">
                    <button class="blueButton" style="margin-bottom: 25px;">Voltar</button>
                </a>
                <form method="post" action="{% url 'excluirAluno' aluno.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="excluirButton" onclick="return confirm('Tem certeza que deseja excluir este aluno?')">Excluir Aluno</button>
                </form>
            </div>


    </body>
{% endblock content %}
